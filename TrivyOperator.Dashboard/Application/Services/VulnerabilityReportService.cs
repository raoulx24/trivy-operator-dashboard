using TrivyOperator.Dashboard.Application.Models;
using TrivyOperator.Dashboard.Application.Services.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.VulnerabilityReport;
using TrivyOperator.Dashboard.Infrastructure.Abstractions;

namespace TrivyOperator.Dashboard.Application.Services;

public class VulnerabilityReportService(IConcurrentCache<string, List<VulnerabilityReportCR>> cache)
    : IVulnerabilityReportService
{
    public Task<List<VulnerabilityDto>> GetTrivyVulnerabilities()
    {
        List<VulnerabilityReportCR> allVulnerabilities = [];
        foreach (string namespaceName in cache.Keys)
        {
            if (cache.TryGetValue(namespaceName, out List<VulnerabilityReportCR>? vulnerabilities))
            {
                allVulnerabilities.AddRange(vulnerabilities);
            }
        }

        return Task.FromResult(GetTrivyVulnerabilityDtos(allVulnerabilities));
    }

    public Task<List<VulnerabilityDto>> GetTrivyVulnerabilities(string namespaceName)
    {
        return cache.TryGetValue(namespaceName, out List<VulnerabilityReportCR>? vulnerabilities)
            ? Task.FromResult(GetTrivyVulnerabilityDtos(vulnerabilities))
            : Task.FromResult<List<VulnerabilityDto>>([]);
    }

    private static List<VulnerabilityDto> GetTrivyVulnerabilityDtos(
        List<VulnerabilityReportCR> vulnerabilityReportCrs)
    {
        List<VulnerabilityDto> dtos = [];
        foreach (VulnerabilityReportCR vulnerabilityReportCr in vulnerabilityReportCrs)
        {
            dtos.AddRange(vulnerabilityReportCr.ToVulnerabilityDtos());
        }

        return dtos;
    }
}
