# Stage 1 - Angular build
FROM node:24 AS build-node
COPY ./src/TrivyOperator.Dashboard/ClientApp /src
WORKDIR /src
RUN npm install
RUN npm run build -- --configuration production

RUN apt-get update && apt-get install -y brotli gzip
WORKDIR /src/dist
RUN find . -type f -name "*.js" -exec gzip -k -1 {} \;
RUN find . -type f -name "*.css" -exec gzip -k -1 {} \;
RUN find . -type f -name "*.html" -exec gzip -k -1 {} \;
RUN find . -type f -name "*.svg" -exec gzip -k -1 {} \;
RUN find . -type f -name "*.js" -exec brotli -k -4 {} \;
RUN find . -type f -name "*.css" -exec brotli -k -4 {} \;
RUN find . -type f -name "*.html" -exec brotli -k -4 {} \;
RUN find . -type f -name "*.svg" -exec brotli -k -4 {} \;

# Stage 2 - dotnet publish
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build-dotnet
COPY ./src /src
ARG FILEVERSION
ARG SEMVERFILEVERSION
RUN dotnet publish /src/TrivyOperator.Dashboard/TrivyOperator.Dashboard.csproj \
    --configuration Release -o /build \
    -p:FileVersion=$FILEVERSION -p:SemVerFileVersion=$SEMVERFILEVERSION

# Stage 3 - Final
FROM mcr.microsoft.com/dotnet/aspnet:9.0-noble-chiseled AS final
COPY --from=build-dotnet /build /opt/trivy.dashboard
COPY --from=build-node /src/dist/browser /opt/trivy.dashboard/wwwroot
WORKDIR /opt/trivy.dashboard
ENTRYPOINT ["dotnet", "TrivyOperator.Dashboard.dll"]