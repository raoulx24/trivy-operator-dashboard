import { Component } from '@angular/core';

import { VulnerabilityReportDenormalizedDto } from '../../../api/models/vulnerability-report-denormalized-dto';
import { VulnerabilityReportsService } from '../../../api/services/vulnerability-reports.service';
import { vulnerabilityReportDenormalizedColumns } from '../constants/vulnerability-reports.constants';

import { TrivyTableComponent } from '../../ui-elements/trivy-table/trivy-table.component';
import { TrivyTableColumn } from '../../ui-elements/trivy-table/trivy-table.types';


@Component({
  selector: 'app-vulnerability-reports-detailed',
  standalone: true,
  imports: [TrivyTableComponent],
  templateUrl: './vulnerability-reports-detailed.component.html',
  styleUrl: './vulnerability-reports-detailed.component.scss',
})
export class VulnerabilityReportsDetailedComponent {
  public dataDtos?: VulnerabilityReportDenormalizedDto[] | null;
  public activeNamespaces: string[] = [];
  public isLoading: boolean = false;

  public csvFileName: string = 'Vulnerability.Reports';

  public trivyTableColumns: TrivyTableColumn[] = [...vulnerabilityReportDenormalizedColumns];

  constructor(private dataDtoService: VulnerabilityReportsService) {
    this.getTableDataDtos();
  }

  public getTableDataDtos() {
    this.isLoading = true;
    this.dataDtoService.getVulnerabilityReportDenormalizedDtos().subscribe({
      next: (res) => this.onGetDataDtos(res),
      error: (err) => console.error(err),
    });
    this.dataDtoService.getVulnerabilityReportActiveNamespaces().subscribe({
      next: (res) => this.onGetActiveNamespaces(res),
      error: (err) => console.error(err),
    });
  }

  onGetDataDtos(dtos: VulnerabilityReportDenormalizedDto[]) {
    this.dataDtos = dtos;
    this.isLoading = false;
  }

  onGetActiveNamespaces(dtos: string[]) {
    this.activeNamespaces = dtos.sort((x, y) => (x > y ? 1 : -1));
  }
}
