import { Component, inject, OnInit } from '@angular/core';

import { ClusterVulnerabilityReportDto } from '../../../api/models/cluster-vulnerability-report-dto';
import { ClusterVulnerabilityReportService } from '../../../api/services/cluster-vulnerability-report.service';
import { GenericMasterDetailComponent } from '../../ui-elements/generic-master-detail/generic-master-detail.component';
import { TrivyFilterData, TrivyTableColumn } from '../../ui-elements/trivy-table/trivy-table.types';
import { vulnerabilityReportComparedTableColumns, vulnerabilityReportDetailColumns } from '../constants/vulnerability-reports.constants';
import { clusterVulnerabilityReportColumns } from '../constants/cluster-vulnerability-reports.constants';
import { Router } from '@angular/router';
import { MessageService } from 'primeng/api';
import { NamespacedImageDto } from '../../ui-elements/namespace-image-selector/namespace-image-selector.types';
import { nonExistingNamespace } from '../../ui-elements/namespace-image-selector/namespace-image-selector.component';
import { Dialog } from 'primeng/dialog';
import {
  GenericReportsCompareComponent
} from '../../ui-elements/generic-reports-compare/generic-reports-compare.component';

@Component({
  selector: 'app-cluster-vulnerability-reports',
  standalone: true,
  imports: [GenericMasterDetailComponent, Dialog, GenericReportsCompareComponent],
  templateUrl: './cluster-vulnerability-reports.component.html',
  styleUrl: './cluster-vulnerability-reports.component.scss',
})
export class ClusterVulnerabilityReportsComponent implements OnInit {
  dataDtos: ClusterVulnerabilityReportDto[] = [];
  selectedTrivyReportDto: ClusterVulnerabilityReportDto | null = null;

  mainTableColumns: TrivyTableColumn[] = [...clusterVulnerabilityReportColumns];
  isMainTableLoading: boolean = true;

  detailsTableColumns: TrivyTableColumn[] = [...vulnerabilityReportDetailColumns];

  isTrivyReportsCompareVisible: boolean = false;
  compareFirstSelectedIdId?: string;
  compareNamespacedImageDtos?: NamespacedImageDto[];
  comparedTableColumns: TrivyTableColumn[] = [... vulnerabilityReportComparedTableColumns];

  private readonly dataDtoService = inject(ClusterVulnerabilityReportService);
  private readonly router = inject(Router);
  private readonly messageService = inject(MessageService);

  ngOnInit() {
    this.getDataDtos();
  }

  private getDataDtos(): void {
    this.isMainTableLoading = true;
    this.dataDtoService.getClusterVulnerabilityReportDtos().subscribe({
      next: (res) => this.onGetDataDtos(res),
      error: (err) => console.error(err),
    });
  }

  onGetDataDtos(dtos: ClusterVulnerabilityReportDto[]) {
    this.dataDtos = dtos;
    this.isMainTableLoading = false;
  }

  public onRefreshRequested(_event: TrivyFilterData) {
    this.getDataDtos();
  }

  onMainTableSelectedRowChanged(event: ClusterVulnerabilityReportDto | null) {
    this.selectedTrivyReportDto = event;
  }

  onMainTableMultiHeaderActionRequested(event: string) {
    switch (event) {
      case "goToDetailedPage":
        this.goToDetailedPage();
        break;
      case "Compare with...":
        this.goToComparePage();
        break;
      default:
        console.error("cvr - multi action call back - unknown: " + event);
    }
  }

  private goToDetailedPage() {
    const url = this.router.serializeUrl(
      this.router.createUrlTree(['/cluster-vulnerability-reports-detailed'])
    );
    window.open(url, '_blank');
  }

  private goToComparePage() {
    if (!this.dataDtos || !this.selectedTrivyReportDto) return;
    if (this.selectedTrivyReportDto.criticalCount < 1 && this.selectedTrivyReportDto.highCount < 1 &&
      this.selectedTrivyReportDto.mediumCount < 1 && this.selectedTrivyReportDto.lowCount < 1 &&
      this.selectedTrivyReportDto.unknownCount < 1) {
      this.messageService.add({
        severity: "info",
        summary: "Nothing to compare",
        detail: "The selected item has no details, so there is nothing to compare...",
      });

      return;
    }

    this.compareNamespacedImageDtos = this.dataDtos
      .filter(cvr => cvr.criticalCount > 0 || cvr.highCount > 0 || cvr.mediumCount > 0 || cvr.lowCount > 0 || cvr.unknownCount > 0)
      .map(cvr => ({
        uid: cvr.uid ?? '', resourceNamespace: nonExistingNamespace,
        mainLabel: `${cvr.imageName ?? ''}:${cvr.imageTag ?? '' }`}));
    this.compareFirstSelectedIdId = this.selectedTrivyReportDto.uid;
    this.isTrivyReportsCompareVisible = true;
  }
}
