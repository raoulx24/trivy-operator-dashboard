import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

import { VulnerabilityReportSumaryDto } from '../../api/models/vulnerability-report-sumary-dto';
import { VrSeveritiesByNsSummaryDetailDto } from '../../api/models/vr-severities-by-ns-summary-detail-dto';
import { PrimeNgChartUtils, PrimeNgHorizontalBarChartData, SeveritiesSummary } from '../utils/primeng-chart.utils';
import { GenericByNsSummaryDto, GenericNsTotalSortable, GenericSummaryDto, OtherSummaryMainStatistics, SeveritySummary } from './home-vulnerability-reports.types';
import { VulnerabilityReportsService } from '../../api/services/vulnerability-reports.service';
import { SeverityHelperService } from '../services/severity-helper.service';

import { ButtonModule } from 'primeng/button';
import { ChartModule } from 'primeng/chart';
import { DialogModule } from 'primeng/dialog';
import { InputSwitchModule } from 'primeng/inputswitch';
import { TableModule } from 'primeng/table';
import { TabViewModule } from 'primeng/tabview';



@Component({
  selector: 'app-home-vulnerability-reports',
  standalone: true,
  imports: [CommonModule, FormsModule, ButtonModule, ChartModule, DialogModule, InputSwitchModule, TableModule, TabViewModule],
  templateUrl: './home-vulnerability-reports.component.html',
  styleUrl: './home-vulnerability-reports.component.scss'
})
export class HomeVulnerabilityReportsComponent {
  public vulnerabilityReportSumaryDto?: VulnerabilityReportSumaryDto | null = null;
  public get primeNgHelper(): PrimeNgChartUtils { return this._primeNgHelper; };
  private _primeNgHelper: PrimeNgChartUtils;

  public horizontalBarChartDataByNs: PrimeNgHorizontalBarChartData | null = { labels: [], datasets: [], title: "" };
  public horizontalBarChartDataBySeverity: PrimeNgHorizontalBarChartData | null = { labels: [], datasets: [], title: "" };
  public horizontalBarChartOption: any;

  public severitiesSummaryForTable: SeveritySummary[] = [];
  public othersSummaryForTable: OtherSummaryMainStatistics[] = [];

  public isMoreVRDetailsModalVisible: boolean = false;
  public moreOthersModalTitle: string = "";
  public isMoreOthersModalVisible: boolean = false;
  public genericSummaryDtos: GenericSummaryDto[] = [];
  public genericByNsSummaryDtos: GenericByNsSummaryDto[] = [];

  public showDistinctValues: boolean = true;

  constructor(private vulnerabilityReportsService: VulnerabilityReportsService, public severityHelperService: SeverityHelperService) {
    console.log("constructor - vr");
    this.vulnerabilityReportsService.getVulnerabilityReportSumaryDto()
      .subscribe({
        next: (res) => this.onVulnerabilityReportSummaryDtos(res),
        error: (err) => console.error(err)
      });
    this._primeNgHelper = new PrimeNgChartUtils(this.severityHelperService);
    severityHelperService.getSeverityDtos().then(_result => {
      this.initComponents();
    });
  }

  private initComponents() {
    const documentStyle = getComputedStyle(document.documentElement);
    const textColor = documentStyle.getPropertyValue('--text-color');
    const textColorSecondary = documentStyle.getPropertyValue('--text-color-secondary');
    const surfaceBorder = documentStyle.getPropertyValue('--surface-border');

    this.horizontalBarChartOption = {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      aspectRatio: 0.6,
      plugins: {
        legend: {
          labels: {
            color: textColor
          },
          position: 'bottom',
        }
      },
      scales: {
        x: {
          ticks: {
            color: textColorSecondary,
            font: {
              weight: 500
            }
          },
          grid: {
            color: surfaceBorder,
            drawBorder: false
          }
        },
        y: {
          ticks: {
            color: textColorSecondary
          },
          grid: {
            color: surfaceBorder,
            drawBorder: false
          }
        }
      }
    };
  }

  onVulnerabilityReportSummaryDtos(vulnerabilityReportSumaryDto?: VulnerabilityReportSumaryDto) {
    this.vulnerabilityReportSumaryDto = vulnerabilityReportSumaryDto;

    if (vulnerabilityReportSumaryDto == null) {
      return;
    }
    this.severityHelperService.getSeverityDtos().then(_ => {
      this.extractDataForCharts();
      this.extractDataForTables();
    });
  }

  private extractDataForCharts() {
    this._primeNgHelper.getDataForHorizontalBarChartByNamespace(
      this.vulnerabilityReportSumaryDto?.severitiesByNsSummaryDtos as SeveritiesSummary[], this.showDistinctValues)
      .then(x => this.horizontalBarChartDataByNs = x);
    this._primeNgHelper.getDataForHorizontalBarChartBySeverity(
      this.vulnerabilityReportSumaryDto?.severitiesByNsSummaryDtos as SeveritiesSummary[], this.showDistinctValues)
      .then(x => this.horizontalBarChartDataBySeverity = x);
  }

  private extractDataForTables() {
    if (this.vulnerabilityReportSumaryDto?.severitiesByNsSummaryDtos) {
      let severitiesTotal = this.vulnerabilityReportSumaryDto.severitiesByNsSummaryDtos.find(x => x.isTotal);
      if (severitiesTotal) {
        let tableValues: SeveritySummary[] = [];
        severitiesTotal.details?.sort((a, b) => a.id! - b.id!).forEach(x => {
          tableValues.push({
            severityName: this.severityHelperService.getCapitalizedName(x.id!),
            count: this.showDistinctValues ? x.distinctCount! : x.totalCount!,
            fixable: this.showDistinctValues ? x.fixableDistinctCount! : x.fixableTotalCount!,
          });
        });
        this.severitiesSummaryForTable = tableValues;
      }
    }
    this.othersSummaryForTable = [];
    if (this.vulnerabilityReportSumaryDto?.imagesByNSSummaryDtos) {
      let totalData = this.vulnerabilityReportSumaryDto.imagesByNSSummaryDtos.find(x => x.isTotal);
      if (totalData) {
        this.othersSummaryForTable.push({
          description: "Images",
          count: this.showDistinctValues ? totalData.distinctCount! : totalData.totalCount!,
        })
      }
    }
    if (this.vulnerabilityReportSumaryDto?.imageOSesByNSSummaryDtos) {
      let totalData = this.vulnerabilityReportSumaryDto.imageOSesByNSSummaryDtos.find(x => x.isTotal);
      if (totalData) {
        this.othersSummaryForTable.push({
          description: "Images OSes",
          count: this.showDistinctValues ? totalData.distinctCount! : totalData.totalCount!,
        })
      }
    }
    if (this.vulnerabilityReportSumaryDto?.imageEOSLByNsSummaryDtos) {
      let totalData = this.vulnerabilityReportSumaryDto.imageEOSLByNsSummaryDtos.find(x => x.isTotal);
      if (totalData) {
        this.othersSummaryForTable.push({
          description: "End of Service Life",
          count: this.showDistinctValues ? totalData.distinctCount! : totalData.totalCount!,
        })
      }
    }
  }

  public onOthersMore(element: OtherSummaryMainStatistics) {
    this.moreOthersModalTitle = "More Info for " + element.description;
    let tempByNsSummary: GenericByNsSummaryDto[] = [];
    let tempSummary: GenericSummaryDto[] = [];
    switch (element.description) {
      case 'Images':
        tempByNsSummary = this.vulnerabilityReportSumaryDto?.imagesByNSSummaryDtos! as GenericByNsSummaryDto[]
        this.genericByNsSummaryDtos = tempByNsSummary.sort(this.sortOthersByNsSummary);
        this.genericSummaryDtos = this.vulnerabilityReportSumaryDto?.imagesSummaryDtos!.sort((a, b) => a.name! > b.name! ? 1 : -1) as GenericSummaryDto[];
        break;
      case 'Images OSes':
        tempByNsSummary = this.vulnerabilityReportSumaryDto?.imageOSesByNSSummaryDtos! as GenericByNsSummaryDto[];
        this.genericByNsSummaryDtos = tempByNsSummary.sort(this.sortOthersByNsSummary);
        this.genericSummaryDtos = this.vulnerabilityReportSumaryDto?.imageOSSummaryDtos!.sort((a, b) => a.name! > b.name! ? 1 : -1) as GenericSummaryDto[];
        break;
      case 'End of Service Life':
        tempByNsSummary = this.vulnerabilityReportSumaryDto?.imageEOSLByNsSummaryDtos! as GenericByNsSummaryDto[];
        this.genericByNsSummaryDtos = tempByNsSummary.sort(this.sortOthersByNsSummary);
        this.genericSummaryDtos = this.vulnerabilityReportSumaryDto?.imageEOSLSummaryDtos!.sort((a, b) => a.name! > b.name! ? 1 : -1) as GenericSummaryDto[];
        break;
    }
    this.isMoreOthersModalVisible = true;
  }

  public onVrsMore(event: MouseEvent) {
    this.isMoreVRDetailsModalVisible = true;
  }

  sortOthersByNsSummary = (a: GenericNsTotalSortable, b: GenericNsTotalSortable): number => {
    if (a.isTotal === b.isTotal) {
      return a.namespaceName > b.namespaceName ? 1 : -1;
    }
    return a.isTotal ? 1 : -1;
  };

  getRowStyle(rowData: GenericNsTotalSortable) {
    return rowData.isTotal ? { 'font-weight': 'bold' } : {};
  }

  getFooterData(fieldName: string): string {
    let dto: GenericByNsSummaryDto = this.genericByNsSummaryDtos.filter(x => x.isTotal)[0];
    if (!dto) {
      return "";
    }
    switch (fieldName) {
      case "namespaceName":
        return dto.namespaceName;
      case "totalCount":
        return dto.totalCount.toString();
      case "distinctCount":
        return dto.distinctCount.toString();
      default:
        return "";
    }
  }

  getSeveritiesDistinctCount(details: VrSeveritiesByNsSummaryDetailDto[], severityId: number): number {
    let detail = details.find(x => x.id === severityId);
    if (detail == null) {
      return 0;
    }

    return this.showDistinctValues ? detail.distinctCount! : detail.totalCount!;
  }

  getSeveritiesFixableCount(details: VrSeveritiesByNsSummaryDetailDto[], severityId: number): number {
    let detail = details?.find(d => d.id === severityId);
    if (detail == null) {
      return 0;
    }

    return this.showDistinctValues ? detail.fixableDistinctCount! : detail.fixableTotalCount!;
  }

  onDistinctSwitch(event: any) {
    this.extractDataForCharts();
    this.extractDataForTables();
  }
}
