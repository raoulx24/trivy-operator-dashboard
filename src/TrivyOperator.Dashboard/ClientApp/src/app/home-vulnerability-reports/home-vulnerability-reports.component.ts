import { CommonModule } from '@angular/common';
import { Component, effect, input, OnInit, ViewChild } from '@angular/core';
import { FormsModule } from '@angular/forms';

import { VulnerabilityReportSummaryDto } from '../../api/models/vulnerability-report-summary-dto';
import { VulnerabilityReportsService } from '../../api/services/vulnerability-reports.service';
import { PrimeNgChartUtils, PrimeNgHorizontalBarChartData, SeveritiesSummary } from '../utils/primeng-chart.utils';
import {
  GenericByNsSummaryDto,
  GenericNsTotalSortable,
  GenericSummaryDto,
  OtherSummaryMainStatistics,
  SeveritySummary,
  VrDetailsDto,
} from './home-vulnerability-reports.types';

import { ButtonModule } from 'primeng/button';
import { CarouselModule } from 'primeng/carousel';
import { ChartModule } from 'primeng/chart';
import { DialogModule } from 'primeng/dialog';
import { TableModule } from 'primeng/table';
import { TagModule } from 'primeng/tag';

import { SeverityCssStyleByIdPipe } from '../pipes/severity-css-style-by-id.pipe';
import { SeverityNameByIdPipe } from '../pipes/severity-name-by-id.pipe';
import { VulnerabilityCountPipe } from '../pipes/vulnerability-count.pipe';
import { SeverityUtils } from '../utils/severity.utils';
import { DarkModeService } from '../services/dark-mode.service';

@Component({
  selector: 'app-home-vulnerability-reports',
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    ButtonModule,
    CarouselModule,
    ChartModule,
    DialogModule,
    TableModule,
    TagModule,
    SeverityCssStyleByIdPipe,
    SeverityNameByIdPipe,
    VulnerabilityCountPipe,
  ],
  templateUrl: './home-vulnerability-reports.component.html',
  styleUrl: './home-vulnerability-reports.component.scss',
})
export class HomeVulnerabilityReportsComponent implements OnInit {
  // backend data
  vulnerabilityReportSummaryDto?: VulnerabilityReportSummaryDto;
  slides: string[] = ['vrByNs', 'vrBySev'];
  // data for charts
  horizontalBarChartDataByNs: PrimeNgHorizontalBarChartData = { labels: [], datasets: [], title: '' };
  horizontalBarChartDataBySeverity: PrimeNgHorizontalBarChartData = { labels: [], datasets: [], title: '' };
  horizontalBarChartOption: any;
  // data for Vulnerability Reports Statistics
  severitiesSummaryForTable: SeveritySummary[] = [];
  isMoreVRDetailsModalVisible: boolean = false;
  vrDetailsReportDtos: VrDetailsDto[] = [];
  vrDetailsReportDtoFooter: VrDetailsDto = { namespaceName: '', isTotal: true, values: [] };
  // data for Various Statistics
  othersSummaryForTable: OtherSummaryMainStatistics[] = [];
  moreOthersModalTitle: string = '';
  isMoreOthersModalVisible: boolean = false;
  genericSummaryDtos: GenericSummaryDto[] = [];
  genericByNsSummaryDtos: GenericByNsSummaryDto[] = [];

  severityIds: number[] = SeverityUtils.severityDtos.map(x => x.id);
  private darkLightMode: 'Dark' | 'Light' = 'Dark';

  showDistinctValues = input.required<boolean>();

  constructor(private vulnerabilityReportsService: VulnerabilityReportsService, private darkModeService: DarkModeService) {
    effect(() => {
      const x = this.showDistinctValues();
      this.extractDataForCharts();
      this.extractDataForTables();
    });
  }

  ngOnInit() {
    this.loadData();
    this.darkModeService.isDarkMode$.subscribe((isDarkMode) => {
      const oldDarkLightMode = this.darkLightMode;
      this.darkLightMode = isDarkMode ? 'Dark' : 'Light';
      if (oldDarkLightMode != this.darkLightMode) {
        setTimeout(() => {
          this.horizontalBarChartOption = PrimeNgChartUtils.getHorizontalBarChartOption();
        }, 0);
      }
    });
    this.horizontalBarChartOption = PrimeNgChartUtils.getHorizontalBarChartOption();
  }

  loadData() {
    this.vulnerabilityReportsService.getVulnerabilityReportSummaryDto().subscribe({
      next: (res) => this.onVulnerabilityReportSummaryDtos(res),
      error: (err) => console.error(err),
    });
  }

  onVulnerabilityReportSummaryDtos(vulnerabilityReportSummaryDto: VulnerabilityReportSummaryDto) {
    this.vulnerabilityReportSummaryDto = vulnerabilityReportSummaryDto;

    this.extractDataForCharts();
    this.extractDataForTables();
  }

  public onOthersMore(element: OtherSummaryMainStatistics) {
    this.moreOthersModalTitle = 'More Info for ' + element.description;
    let tempByNsSummary: GenericByNsSummaryDto[] = [];
    const tempSummary: GenericSummaryDto[] = [];
    switch (element.description) {
      case 'Images':
        tempByNsSummary = this.vulnerabilityReportSummaryDto?.imagesByNSSummaryDtos! as GenericByNsSummaryDto[];
        this.genericByNsSummaryDtos = tempByNsSummary.sort(this.sortOthersByNsSummary);
        this.genericSummaryDtos = this.vulnerabilityReportSummaryDto?.imagesSummaryDtos!.sort((a, b) =>
          a.name! > b.name! ? 1 : -1,
        ) as GenericSummaryDto[];
        break;
      case 'Images OSes':
        tempByNsSummary = this.vulnerabilityReportSummaryDto?.imageOSesByNSSummaryDtos! as GenericByNsSummaryDto[];
        this.genericByNsSummaryDtos = tempByNsSummary.sort(this.sortOthersByNsSummary);
        this.genericSummaryDtos = this.vulnerabilityReportSummaryDto?.imageOSSummaryDtos!.sort((a, b) =>
          a.name! > b.name! ? 1 : -1,
        ) as GenericSummaryDto[];
        break;
      case 'End of Service Life':
        tempByNsSummary = this.vulnerabilityReportSummaryDto?.imageEOSLByNsSummaryDtos! as GenericByNsSummaryDto[];
        this.genericByNsSummaryDtos = tempByNsSummary.sort(this.sortOthersByNsSummary);
        this.genericSummaryDtos = this.vulnerabilityReportSummaryDto?.imageEOSLSummaryDtos!.sort((a, b) =>
          a.name! > b.name! ? 1 : -1,
        ) as GenericSummaryDto[];
        break;
    }
    this.isMoreOthersModalVisible = true;
  }

  public onVrsMore(_event: MouseEvent) {
    this.isMoreVRDetailsModalVisible = true;
  }

  sortOthersByNsSummary = (a: GenericNsTotalSortable, b: GenericNsTotalSortable): number => {
    if (a.isTotal === b.isTotal) {
      return a.namespaceName > b.namespaceName ? 1 : -1;
    }
    return a.isTotal ? 1 : -1;
  };

  getFooterData(fieldName: string): string {
    const dto: GenericByNsSummaryDto = this.genericByNsSummaryDtos.filter((x) => x.isTotal)[0];
    if (!dto) {
      return '';
    }
    switch (fieldName) {
      case 'namespaceName':
        return dto.namespaceName;
      case 'totalCount':
        return dto.totalCount.toString();
      case 'distinctCount':
        return dto.distinctCount.toString();
      default:
        return '';
    }
  }

  onDistinctSwitch(showDistinctValues: boolean) {
    if (this.vulnerabilityReportSummaryDto) {
      this.extractDataForCharts();
      this.extractDataForTables();
    }
  }

  private extractDataForCharts() {
    this.horizontalBarChartDataByNs = PrimeNgChartUtils.getDataForHorizontalBarChartByNamespace(
      this.vulnerabilityReportSummaryDto?.severitiesByNsSummaryDtos as SeveritiesSummary[] ?? [],
      this.showDistinctValues(),
    );
    this.horizontalBarChartDataBySeverity = PrimeNgChartUtils.getDataForHorizontalBarChartBySeverity(
      this.vulnerabilityReportSummaryDto?.severitiesByNsSummaryDtos as SeveritiesSummary[] ?? [],
      this.showDistinctValues(),
    );
  }

  private extractDataForTables() {
    if (this.vulnerabilityReportSummaryDto?.severitiesByNsSummaryDtos) {
      const severitiesTotal = this.vulnerabilityReportSummaryDto.severitiesByNsSummaryDtos.find((x) => x.isTotal);
      if (severitiesTotal) {
        const tableValues: SeveritySummary[] = [];
        severitiesTotal.details
          ?.sort((a, b) => a.id! - b.id!)
          .forEach((x) => {
            tableValues.push({
              severityName: SeverityUtils.getCapitalizedName(x.id!),
              count: this.showDistinctValues() ? x.distinctCount! : x.totalCount!,
              fixable: this.showDistinctValues() ? x.fixableDistinctCount! : x.fixableTotalCount!,
            });
          });
        this.severitiesSummaryForTable = tableValues;
      }
    }
    this.othersSummaryForTable = [];
    if (this.vulnerabilityReportSummaryDto?.imagesByNSSummaryDtos) {
      const totalData = this.vulnerabilityReportSummaryDto.imagesByNSSummaryDtos.find((x) => x.isTotal);
      if (totalData) {
        this.othersSummaryForTable.push({
          description: 'Images',
          count: this.showDistinctValues() ? totalData.distinctCount! : totalData.totalCount!,
        });
      }
    }
    if (this.vulnerabilityReportSummaryDto?.imageOSesByNSSummaryDtos) {
      const totalData = this.vulnerabilityReportSummaryDto.imageOSesByNSSummaryDtos.find((x) => x.isTotal);
      if (totalData) {
        this.othersSummaryForTable.push({
          description: 'Images OSes',
          count: this.showDistinctValues() ? totalData.distinctCount! : totalData.totalCount!,
        });
      }
    }
    if (this.vulnerabilityReportSummaryDto?.imageEOSLByNsSummaryDtos) {
      const totalData = this.vulnerabilityReportSummaryDto.imageEOSLByNsSummaryDtos.find((x) => x.isTotal);
      if (totalData) {
        this.othersSummaryForTable.push({
          description: 'End of Service Life',
          count: this.showDistinctValues() ? totalData.distinctCount! : totalData.totalCount!,
        });
      }
    }
    if (this.vulnerabilityReportSummaryDto?.severitiesByNsSummaryDtos) {
      const x = this.vulnerabilityReportSummaryDto.severitiesByNsSummaryDtos
        .map(({ namespaceName, details, isTotal }) => {
          const values: { severityId: number, count: number }[] = [];
          this.severityIds.forEach(severityId => {
            const detail = details?.find(det => det.id === severityId);
            values.push({ severityId: severityId, count: this.showDistinctValues() ? detail?.distinctCount ?? -1 : detail?.totalCount ?? -1 });
            values.push({ severityId: severityId, count: this.showDistinctValues() ? detail?.fixableDistinctCount ?? -1 : detail?.fixableTotalCount ?? -1 });
          });

          return { namespaceName: namespaceName, values: values, isTotal };
        });
      this.vrDetailsReportDtos = x.filter(x => !x.isTotal)
        .sort((a, b) => {
          return a.namespaceName.localeCompare(b.namespaceName);
        });
      this.vrDetailsReportDtoFooter = x.find(x => x.isTotal) ?? this.vrDetailsReportDtoFooter;
    }
  }
}
