<h3 id="tableLabel">Vulnerability Reports Detailed</h3>

<p *ngIf="!vulnerabilityReportsDetailedDtos"><em>Loading...</em></p>

<p-table *ngIf="false" #vrdTable
         [columns]="tableColumns"
         [value]="vulnerabilityReportsDetailedDtos!"
         [scrollable]="true"
         scrollHeight="60vh"
         [virtualScroll]="true"
         [virtualScrollItemSize]="46"
         [tableStyle]="{ 'font-size': '14px' }"
         [resizableColumns]="true"
         columnResizeMode="expand"
         [reorderableColumns]="true"
         styleClass="p-datatable-sm"
         sortMode="multiple"
         [autoLayout]="true"
         selectionMode="multiple"
         [(selection)]="selectedVrdDtos"
         [exportFilename]="csvFileName">
  <ng-template pTemplate="caption">
    <div>
      <a class="m-1 p-1">CSV File Name</a>
      <input class="m-1 p-1" pInputText [(ngModel)]="csvFileName" />
      <p-splitButton class="m-1 p-1"
                     icon="pi pi-download"
                     label="Export Filtered to CSV"
                     (onClick)="vrdTable.exportCSV()"
                     [model]="saveCsvMenuItems" />
    </div>
    
  </ng-template>
  <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="resourceNamespace" pResizableColumn style="width: 130px; max-width: 130px;">
        NS
        <p-sortIcon field="resourceNamespace" />
        <p-columnFilter field="resourceNamespace" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
          <ng-template pTemplate="filter" let-filter="filterCallback">
            <p-multiSelect [(ngModel)]="filterActiveNamespaces"
                           [options]="activeNamespaces!"
                           placeholder="Any"
                           (onChange)="filter($event.value)"
                           optionLabel=""
                           [style]="{'font-size':'14px', 'width':'300px'}">
            </p-multiSelect>
            <ng-template let-option pTemplate="item">
              <div [style]="{'font-size':'14px'}" >{{ option }}</div>
            </ng-template>
          </ng-template>
        </p-columnFilter>
      </th>
      <th pSortableColumn="resourceContainerName" pResizableColumn style="width: 170px; max-width: 170px;">
        Container
        <p-sortIcon field="resourceContainerName" />
        <p-columnFilter type="text" field="resourceContainerName" display="menu" />
      </th>
      <th pResizableColumn style="width: 330px; max-width: 330px;">
        Image Name - Tag
        <p-columnFilter type="text" field="imageName" display="menu" />
      </th>
      <th pSortableColumn="severityId" pResizableColumn style="width: 100px; max-width: 100px;">
        Sev
        <p-sortIcon field="severityId" />
        <p-columnFilter field="severityId" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
          <ng-template pTemplate="filter" let-filter="filterCallback">
            <p-multiSelect [(ngModel)]="filterSelectedSeverityIds"
                           [options]="filterSeverityOptions"
                           placeholder="Any"
                           (onChange)="filter($event.value)"
                           optionLabel="name"
                           [style]="{'font-size':'14px'}"
                           [filter]="false"
                           [showToggleAll]="false"
                           [showHeader]="false">
              <ng-template let-severityIds pTemplate="selectedItems">
                <div>{{ getSeverityCssColors(severityIds, 2) }}</div>
              </ng-template>
              <ng-template let-option pTemplate="item">
                <div [style]="{'font-size':'14px'}" class="flex align-items-center gap-2">{{ getSeverityName(option) }}</div>
              </ng-template>
            </p-multiSelect>

          </ng-template>
        </p-columnFilter>
      </th>
      <th pResizableColumn>Tiltle</th>
      <th pResizableColumn style="width: 150px; max-width: 150px; ">CVE</th>
    </tr>
    <!--<tr>
      <th>
        <p-columnFilter type="text"
                        field="resourceNamespace"
                        placeholder="Search by Namespace"
                        ariaLabel="Filter Name"
                        [style]="{'font-size':'14px'}" />
      </th>
      <th>
        <p-columnFilter type="text"
                        field="resourceContainerName"
                        placeholder="Search by Container"
                        ariaLabel="Filter Name"
                        [style]="{'font-size':'14px'}" />
      </th>
      <th>
        <p-columnFilter type="text"
                        field="imageName"
                        placeholder="Search by Image Name"
                        ariaLabel="Filter Name"
                        [style]="{'font-size':'14px'}" />
      </th>
      <th>
        <p-columnFilter type="text"
                        field="severityId"
                        placeholder="Search by Severity"
                        ariaLabel="Filter Name"
                        [style]="{'font-size':'14px'}" />
      </th>
      <th>
        <p-columnFilter type="text"
                        field="title"
                        placeholder="Search by Title"
                        ariaLabel="Filter Name"
                        [style]="{'font-size':'14px'}" />
      </th>
      <th>
        <p-columnFilter type="text"
                        field="vulnerabilityId"
                        placeholder="Search by CVE"
                        ariaLabel="Filter Name"
                        [style]="{'font-size':'14px'}" />
      </th>
    </tr>-->
  </ng-template>
  <ng-template pTemplate="body" let-vrdDto let-rowIndex="rowIndex">
    <tr style="height:46px" [pSelectableRow]="vrdDto" [pSelectableRowIndex]="rowIndex">
      <td style="width: 130px; max-width: 130px; ">{{ vrdDto.resourceNamespace }}</td>
      <td style="width: 170px; max-width: 170px; ">{{ vrdDto.resourceContainerName }}</td>
      <td style="width: 330px; max-width: 330px; ">{{ vrdDto.imageName }}:{{ vrdDto.imageTag }}</td>
      <td style="width: 100px; max-width: 100px; "><p-tag [value]="getSeverityShortName(vrdDto.severityId)" [style]="{ background: getSeverityCssColor(vrdDto.severityId) }" /></td>
      <td style="white-space: normal;">{{ vrdDto.title }}</td>
      <td style="width: 150px; max-width: 150px; ">
        <a href="{{ vrdDto.primaryLink }}" target="_blank">
          {{ vrdDto.vulnerabilityId }} <i class="pi pi-external-link" style="font-size: 14px"></i>
        </a>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="summary">
    <div>
      {{ getTableFooterInfo() }}
      <!--Records {{ vrdTable.filteredValue? vrdTable.filteredValue.length : (vulnerabilityReportsDetailedDtos ? vulnerabilityReportsDetailedDtos.length : 0) }} out of
  {{ vulnerabilityReportsDetailedDtos ? vulnerabilityReportsDetailedDtos.length : 0 }}.-->
    </div>
  </ng-template>
</p-table>

<p-table #vrdTableTest
         [columns]="trivyTableColumns"
         [value]="vulnerabilityReportsDetailedDtos!"
         [scrollable]="true"
         scrollHeight="75vh"
         [virtualScroll]="true"
         [virtualScrollItemSize]="66"
         [tableStyle]="{ 'font-size': '14px' }"
         [resizableColumns]="true"
         columnResizeMode="expand"
         [reorderableColumns]="true"
         styleClass="p-datatable-sm"
         sortMode="multiple"
         [autoLayout]="true"
         [selectionMode]="trivyTableOptions.tableSelectionMode"
         [(selection)]="selectedVrdDtos"
         [exportFilename]="csvFileName">
  <ng-template pTemplate="caption">
    <div>
      <p-button *ngIf="trivyTableOptions.isExportCsvVisible" class="m-1 p-1" label="Export to CSV" size="small" (onClick)="csvExportOp.toggle($event)" />
      <p-button *ngIf="trivyTableOptions.isClearSelectionVisible" class="m-1 p-1" label="Clear Selected" size="small" [disabled]="!isSelected()" (onClick)="onClearSelected()" />
      <p-button *ngIf="trivyTableOptions.isResetFiltersVisible" class="m-1 p-1" label="Clear Filters" size="small" [disabled]="!vrdTableTest.filteredValue" (onClick)="vrdTableTest.clear()" />
    </div>
  </ng-template>
  <ng-template pTemplate="header" let-columns>
    <tr>
      <th *ngFor="let col of columns" pResizableColumn [pSortableColumn]="col.isSortable ? col.field : null" style="{{ col.style }}">
        {{ col.header }}
        <p-sortIcon *ngIf="col.isSortable" field="{{ col.field }}" />
        <p-columnFilter *ngIf="col.isFiltrable && col.multiSelectType===''" type="text" field="{{ col.field }}" display="menu" />
        <p-columnFilter *ngIf="col.isFiltrable && col.multiSelectType==='namespaces'" field="{{ col.field }}" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
          <ng-template pTemplate="filter" let-filter="filterCallback">
            <p-multiSelect [(ngModel)]="filterActiveNamespaces"
                           [options]="activeNamespaces!"
                           placeholder="Any"
                           (onChange)="filter($event.value)"
                           optionLabel=""
                           [style]="{'font-size':'14px', 'width':'300px'}">
            </p-multiSelect>
            <ng-template let-option pTemplate="item">
              <div [style]="{'font-size':'14px'}">{{ option }}</div>
            </ng-template>
          </ng-template>
        </p-columnFilter>
        <p-columnFilter *ngIf="col.isFiltrable && col.multiSelectType==='severities'" field="{{ col.field }}" matchMode="in" display="menu" [showMatchModes]="false" [showOperator]="false" [showAddButton]="false">
          <ng-template pTemplate="filter" let-filter="filterCallback">
            <p-multiSelect [(ngModel)]="filterSelectedSeverityIds"
                           [options]="filterSeverityOptions"
                           placeholder="Any"
                           (onChange)="filter($event.value)"
                           optionLabel="name"
                           [style]="{'font-size':'14px'}"
                           [filter]="false"
                           [showToggleAll]="false"
                           [showHeader]="false">
              <ng-template let-severityIds pTemplate="selectedItems">
                <div>{{ getSeverityCssColors(severityIds, 2) }}</div>
              </ng-template>
              <ng-template let-option pTemplate="item">
                <div [style]="{'font-size':'14px'}" class="flex align-items-center gap-2">{{ getSeverityName(option) }}</div>
              </ng-template>
            </p-multiSelect>

          </ng-template>
        </p-columnFilter>
      </th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-rowData let-columns="columns" let-rowIndex="rowIndex">
    <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
      <td *ngFor="let col of columns" style="{{ col.style }}">
        <a *ngIf="!col.isSeverityBadge && !col.isImageNameTag && !col.isLink">{{ rowData[col.field] }}</a>
        <a *ngIf="col.isImageNameTag">{{ rowData[col.field] }}:{{ rowData[col.extraField] }}</a>
        <a *ngIf="col.isLink" href="{{ rowData[col.extraField] }}" target="_blank">{{ rowData[col.field] }}</a>
        <p-tag *ngIf="col.isSeverityBadge" [value]="getSeverityShortName(rowData[col.field])" [style]="{ background: getSeverityCssColor(rowData[col.field]) }" />
      </td>
    </tr>
  </ng-template>

</p-table>

<p-overlayPanel #csvExportOp>
  <div class="flex flex-column gap-3 w-25rem">
    <div>
      <span style="font-size: 12px; padding-left: 2px;">CSV File Name</span>
    </div>
    <div>
      <input pInputText style="font-size: 14px; width: 100%; margin-top: 10px;" [(ngModel)]="csvFileName" />
    </div>
    <p></p>
    <div class="btn-group">
      <p-button label="Export Filtered"
                size="small"
                [disabled]="!vrdTableTest.filteredValue"
                (onClick)="vrdTableTest.exportCSV()"/>
      <p-button class="m-1 p-1"
                label="Export All"
                size="small"
                (onClick)="vrdTableTest.exportCSV({ allValues: true })"/>
      <p-button label="Export Selected"
                size="small"
                [disabled]="!isSelected()"
                (onClick)="onExportFiltered()"/>
    </div>
  </div>
</p-overlayPanel>
