import { Component } from '@angular/core';
import { VulnerabilityReportsService } from "../../api/services/vulnerability-reports.service";
import { VulnerabilityReportDenormalizedDto } from "../../api/models/vulnerability-report-denormalized-dto";
import { SeverityHelperService } from "../services/severity-helper.service"
import { SeverityDto } from "../../api/models/severity-dto"

import { TrivyTableComponent } from '../trivy-table/trivy-table.component';
import { ExportColumn, TrivyTableColumn, TrivyTableOptions } from "../trivy-table/trivy-table.types";

@Component({
  selector: 'app-vulnerability-reports-detailed',
  standalone: true,
  imports: [TrivyTableComponent],
  templateUrl: './vulnerability-reports-detailed.component.html',
  styleUrl: './vulnerability-reports-detailed.component.css',
})

export class VulnerabilityReportsDetailedComponent {
  
  public rowSelection: "single" | "multiple" = "multiple";
  public vulnerabilityReportsDetailedDtos?: VulnerabilityReportDenormalizedDto[] | null | undefined;
  public severityDtos?: SeverityDto[] | null | undefined;
  public activeNamespaces?: string[] | null | undefined = [];
  public isLoading: boolean = false;

  public csvFileName: string = "Vulnerability.Reports";

  public exportCoumns!: ExportColumn[];

  public trivyTableColumns: TrivyTableColumn[] = [];
  public trivyTableOptions: TrivyTableOptions;

  constructor(private vulnerabilityReportsService: VulnerabilityReportsService) {
    this.getTableDataDtos();

    this.exportCoumns = [
      { dataKey: 'resourceNamespace', title: 'NS' },
      { dataKey: 'resourceName', title: 'Name' },
      { dataKey: 'resourceKind', title: 'Kind' },
      { dataKey: 'resourceContainerName', title: 'Container' },

      { dataKey: 'imageName', title: 'ImageName' },
      { dataKey: 'imageTag', title: 'ImageTag' },
      { dataKey: 'imageRepository', title: 'Repository' },
      { dataKey: 'imageOsFamily', title: 'OS Family' },
      { dataKey: 'imageOsName', title: 'OS Name' },
      { dataKey: 'imageEosl', title: 'EOSL' },

      { dataKey: 'resource', title: 'Resource' },
      { dataKey: 'title', title: 'Title' },
      { dataKey: 'severityId', title: 'SeverityId' },
      { dataKey: 'installedVersion', title: 'Installed Version' },
      { dataKey: 'fixedVersion', title: 'Fixed Version' },
      { dataKey: 'publishedDate', title: 'Published' },
      { dataKey: 'lastModifiedDate', title: 'Modified' },
      { dataKey: 'score', title: 'Score' },
      { dataKey: 'vulnerabilityId', title: 'CVE' },
    ];
    this.trivyTableColumns = [
      
      {
        field: "resourceNamespace", header: "NS",
        isFiltrable: true, isSortable: true, multiSelectType: "namespaces",
        style: "width: 130px; max-width: 130px;", renderType: "standard",
      },
      {
        field: "resourceName", header: "Name",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 280px; max-width: 280px;", renderType: "standard",
      },
      {
        field: "resourceKind", header: "Kind",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 110px; max-width: 110px;", renderType: "standard",
      },
      {
        field: "resourceContainerName", header: "Container",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 170px; max-width: 170px;", renderType: "standard",
      },
      {
        field: "imageName", header: "Image",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 210px; max-width: 210px;", renderType: "standard",
      },
      {
        field: "imageTag", header: "Tag",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 115px; max-width: 115px;", renderType: "standard",
      },
      {
        field: "imageRepository", header: "Repository",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 220px; max-width: 220px;", renderType: "standard",
      },
      {
        field: "imageOsFamily", header: "OSFam",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 130px; max-width: 130px;", renderType: "standard",
      },
      {
        field: "imageOsName", header: "OSName",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 130px; max-width: 130px;", renderType: "standard",
      },
      {
        field: "imageEosl", header: "EOSL",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 110px; max-width: 110px;", renderType: "eosl",
      },

      //{ dataKey: 'resource', title: 'Resource' },
      //{ dataKey: 'title', title: 'Title' },
      //{ dataKey: 'severityId', title: 'SeverityId' },
      //{ dataKey: 'installedVersion', title: 'Installed Version' },
      //{ dataKey: 'fixedVersion', title: 'Fixed Version' },
      //{ dataKey: 'publishedDate', title: 'Published' },
      //{ dataKey: 'lastModifiedDate', title: 'Modified' },
      //{ dataKey: 'score', title: 'Score' },
      //{ dataKey: 'vulnerabilityId', title: 'CVE' },

      {
        field: "resource", header: "Resource",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 150px; max-width: 150px;", renderType: "standard",
      },
      {
        field: "title", header: "Title",
        isFiltrable: false, isSortable: false, multiSelectType: "none",
        style: "width: 450px; max-width: 450px; white-space: normal;", renderType: "standard",
      },
      {
        field: "severityId", header: "Sev",
        isFiltrable: true, isSortable: true, multiSelectType: "severities",
        style: "width: 125px; max-width: 125px;", renderType: "severityBadge",
      },
      {
        field: "installedVersion", header: "Installed Ver",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 150px; max-width: 150px;", renderType: "standard",
      },
      {
        field: "fixedVersion", header: "Fixed Ver",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 150px; max-width: 150px;", renderType: "standard",
      },
      {
        field: "publishedDate", header: "Publish",
        isFiltrable: false, isSortable: true, multiSelectType: "none",
        style: "width: 130px; max-width: 200px;", renderType: "date",
      },
      {
        field: "lastModifiedDate", header: "Modif",
        isFiltrable: false, isSortable: true, multiSelectType: "none",
        style: "width: 130px; max-width: 200px;", renderType: "date",
      },
      {
        field: "score", header: "Score",
        isFiltrable: false, isSortable: true, multiSelectType: "none",
        style: "width: 110px; max-width: 110px;", renderType: "standard",
      },
      
      {
        field: "vulnerabilityId", header: "CVE",
        isFiltrable: true, isSortable: true, multiSelectType: "none",
        style: "width: 150px; max-width: 150px;", renderType: "link",
        extraFields: ["primaryLink"],
      },
      
    ]
    this.trivyTableOptions = {
      isClearSelectionVisible: false,
      isExportCsvVisible: true,
      isResetFiltersVisible: true,
      isRefreshVisible: true,
      isRefreshFiltrable: false,
      isFooterVisible: true,
      tableSelectionMode: null,
      tableStyle: { 'width': '3300px' },
      stateKey: "Vulnerability Reports Detailed",
      dataKey: null,
      extraClasses: "",
    };
  }

  public getTableDataDtos() {
    this.isLoading = true;
    this.vulnerabilityReportsService.getVulnerabilityReportDenormalizedDto()
      .subscribe({
        next: (res) => this.onGetVulnerabilityReportDenormalizedDto(res),
        error: (err) => console.error(err)
      });
    this.vulnerabilityReportsService.getVulnerabilityReportActiveNamespaces()
      .subscribe({
        next: (res) => this.onGetActiveNamespaces(res),
        error: (err) => console.error(err)
      })
  }

  onGetVulnerabilityReportDenormalizedDto(dtos: VulnerabilityReportDenormalizedDto[]) {
    this.vulnerabilityReportsDetailedDtos = dtos;
    this.isLoading = false;
  }

  onGetActiveNamespaces(dtos: string[]) {
    this.activeNamespaces = dtos.sort((x, y) => x > y ? 1 : -1);
  }
}
