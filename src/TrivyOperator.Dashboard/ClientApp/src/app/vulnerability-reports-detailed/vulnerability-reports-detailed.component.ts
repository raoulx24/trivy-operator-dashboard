import { Component } from '@angular/core';
import { ColDef, CsvExportParams, GridApi, GridReadyEvent, ValueGetterParams, } from "ag-grid-community";
import { VulnerabilityReportsService } from "../../api/services/vulnerability-reports.service";
import { VulnerabilityReportDenormalizedDto } from "../../api/models/vulnerability-report-denormalized-dto";
import { VulnerabilitySeverityRenderer } from "./vulnerability-severity-renderer.component";

@Component({
  selector: 'app-vulnerability-reports-detailed',
  templateUrl: './vulnerability-reports-detailed.component.html',
  styleUrl: './vulnerability-reports-detailed.component.css',
})

export class VulnerabilityReportsDetailedComponent {
  public rowSelection: "single" | "multiple" = "multiple";
  public vulnerabilityReportsDetailedDtos?: VulnerabilityReportDenormalizedDto[] | null | undefined;
  public columnDefs: ColDef[] = [
    { headerName: 'Namespace', field: "resourceNamespace", filter: true, flex: 3},
    { headerName: 'Container', field: "resourceContainerName", filter: true, flex: 3},
    {
      headerName: 'Image Name and Tag', field: "imageName", filter: true, flex: 9,
      valueGetter: (params: ValueGetterParams) =>
        params.data.imageName + ":" + params.data.imageTag,
    },
    {
      headerName: '',
      field: "severity",
      filter: true,
      flex: 1,
      minWidth: 80,
      cellRenderer: VulnerabilitySeverityRenderer
    },
    {headerName: 'Title', field: "title", filter: true, flex: 15, wrapText: true, autoHeight: true},
    {
      headerName: 'CVE', field: "vulnerabilityId", filter: true, flex: 6,
      cellRenderer: (params: ValueGetterParams) => (`<a href="${params.data.primaryLink}" target="_blank">${params.data.vulnerabilityId}</a>`)
    },
  ];
  public defaultColDef: ColDef = {
    floatingFilter: true,
    suppressFloatingFilterButton: true,
  };
  private gridExportParams: CsvExportParams = {columnSeparator: ",", onlySelected: true};
  private gridApi!: GridApi;

  constructor(vulnerabilityReportsService: VulnerabilityReportsService) {
    vulnerabilityReportsService.getVulnerabilityReportDenormalizedDto().subscribe(result => this.vulnerabilityReportsDetailedDtos = result, error => console.error(error))
  }

  onBtnExport() {
    this.gridApi.exportDataAsCsv(this.gridExportParams);
  }

  onGridReady(params: GridReadyEvent) {
    this.gridApi = params.api;
  }
}
