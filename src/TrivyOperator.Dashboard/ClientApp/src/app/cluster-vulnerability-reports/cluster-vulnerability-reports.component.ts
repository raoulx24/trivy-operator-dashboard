import { Component } from '@angular/core';

import { ClusterVulnerabilityReportDto } from '../../api/models/cluster-vulnerability-report-dto';
import { ClusterVulnerabilityReportService } from '../../api/services/cluster-vulnerability-report.service';
import { GenericMasterDetailComponent } from '../generic-master-detail/generic-master-detail.component';
import { TrivyFilterData, TrivyTableColumn, TrivyTableOptions } from '../trivy-table/trivy-table.types';

@Component({
  selector: 'app-cluster-vulnerability-reports',
  standalone: true,
  imports: [GenericMasterDetailComponent],
  templateUrl: './cluster-vulnerability-reports.component.html',
  styleUrl: './cluster-vulnerability-reports.component.scss',
})
export class ClusterVulnerabilityReportsComponent {
  dataDtos: ClusterVulnerabilityReportDto[] = [];
  selectedDto: ClusterVulnerabilityReportDto | null = null;

  public mainTableColumns: TrivyTableColumn[] = [];
  public mainTableOptions: TrivyTableOptions;
  public isMainTableLoading: boolean = true;

  public detailsTableColumns: TrivyTableColumn[] = [];
  public detailsTableOptions: TrivyTableOptions;

  constructor(private dataDtoService: ClusterVulnerabilityReportService) {
    dataDtoService.getClusterVulnerabilityReportDtos().subscribe({
      next: (res) => this.onGetDataDtos(res),
      error: (err) => console.error(err),
    });

    this.mainTableColumns = [
      {
        field: 'imageName',
        header: 'Image Name - Tag',
        isFiltrable: true,
        isSortable: true,
        multiSelectType: 'none',
        style: 'white-space: normal;',
        renderType: 'imageNameTag',
        extraFields: ['imageTag', 'imageEosl'],
      },
      {
        field: 'imageOsFamily',
        header: 'OS Name - Ver',
        isFiltrable: true,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 265px; max-width: 265px; white-space: normal;',
        renderType: 'imageNameTag',
        extraFields: ['imageOsName'],
      },
      {
        field: 'criticalCount',
        header: 'C',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 50px; max-width: 50px;',
        renderType: 'severityValue',
        extraFields: ['0'],
      },
      {
        field: 'highCount',
        header: 'H',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 50px;',
        renderType: 'severityValue',
        extraFields: ['1'],
      },
      {
        field: 'mediumCount',
        header: 'M',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 50px; max-width: 50px;',
        renderType: 'severityValue',
        extraFields: ['2'],
      },
      {
        field: 'lowCount',
        header: 'L',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 50px; max-width: 50px;',
        renderType: 'severityValue',
        extraFields: ['3'],
      },
    ];
    this.mainTableOptions = {
      isClearSelectionVisible: false,
      isExportCsvVisible: false,
      isResetFiltersVisible: true,
      isRefreshVisible: true,
      isRefreshFiltrable: false,
      isFooterVisible: true,
      tableSelectionMode: 'single',
      tableStyle: { width: '595px' },
      stateKey: 'Cluster Vulnerability Reports - Main',
      dataKey: null,
      rowExpansionRender: null,
      extraClasses: 'trivy-half',
    };
    this.detailsTableColumns = [
      {
        field: 'severityId',
        header: 'Sev',
        isFiltrable: true,
        isSortable: true,
        multiSelectType: 'severities',
        style: 'width: 90px; max-width: 90px;',
        renderType: 'severityBadge',
      },
      {
        field: 'resource',
        header: 'Resource',
        isFiltrable: true,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 130px; max-width: 130px',
        renderType: 'standard',
      },
      {
        field: 'title',
        header: 'Title',
        isFiltrable: true,
        isSortable: false,
        multiSelectType: 'none',
        style: 'min-with: 200px; white-space: normal;',
        renderType: 'standard',
      },
      {
        field: 'installedVersion',
        header: 'Installed Ver',
        isFiltrable: true,
        isSortable: false,
        multiSelectType: 'none',
        style: 'width: 120px; max-width: 120px',
        renderType: 'standard',
      },
      {
        field: 'fixedVersion',
        header: 'Fixed Ver',
        isFiltrable: true,
        isSortable: false,
        multiSelectType: 'none',
        style: 'width: 120px; max-width: 120px',
        renderType: 'standard',
      },
      {
        field: 'publishedDate',
        header: 'Publish',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 900px; max-width: 90px',
        renderType: 'date',
      },
      {
        field: 'lastModifiedDate',
        header: 'Modif',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 90px; max-width: 90px',
        renderType: 'date',
      },
      {
        field: 'score',
        header: 'Score',
        isFiltrable: false,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 70px; max-width: 70px',
        renderType: 'standard',
      },
      {
        field: 'vulnerabilityId',
        header: 'CVE',
        isFiltrable: true,
        isSortable: true,
        multiSelectType: 'none',
        style: 'width: 150px; max-width: 150px;',
        renderType: 'link',
        extraFields: ['primaryLink'],
      },
    ];
    this.detailsTableOptions = {
      isClearSelectionVisible: false,
      isExportCsvVisible: false,
      isResetFiltersVisible: true,
      isRefreshVisible: false,
      isRefreshFiltrable: false,
      isFooterVisible: false,
      tableSelectionMode: null,
      tableStyle: {},
      stateKey: 'Cluster Vulnerability Reports - Details',
      dataKey: null,
      rowExpansionRender: null,
      extraClasses: 'trivy-half',
    };
  }

  onGetDataDtos(dtos: ClusterVulnerabilityReportDto[]) {
    this.dataDtos = dtos;
  }

  public onRefreshRequested(_event: TrivyFilterData) {
    this.isMainTableLoading = true;
    this.dataDtoService.getClusterVulnerabilityReportDtos().subscribe({
      next: (res) => this.onGetDataDtos(res),
      error: (err) => console.error(err),
    });
  }
}
