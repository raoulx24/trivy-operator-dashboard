using k8s;
using TrivyOperator.Dashboard.Domain.Services.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.CustomResources.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.VulnerabilityReport;
using TrivyOperator.Dashboard.Infrastructure.Abstractions;

namespace TrivyOperator.Dashboard.Domain.Services;

public class VulnerabilityReportDomainService(
    IKubernetesClientFactory kubernetesClientFactory,
    IKubernetesNamespaceDomainService kubernetesNamespaceDomainService) : IVulnerabilityReportDomainService
{
    private readonly Kubernetes kubernetesClient = kubernetesClientFactory.GetClient();

    public async Task<IList<VulnerabilityReportCr>> GetTrivyVulnerabilities()
    {
        List<string> namespaceNames = await kubernetesNamespaceDomainService.GetKubernetesNamespaces();
        List<VulnerabilityReportCr> vulnerabilities = [];
        foreach (string namespaceName in namespaceNames)
        {
            vulnerabilities.AddRange(await GetTrivyVulnerabilities(namespaceName));
        }

        return vulnerabilities;
    }

    public async Task<IList<VulnerabilityReportCr>> GetTrivyVulnerabilities(string namespaceName)
    {
        VulnerabilityReportCrd myCrd = new();
        CustomResourceList<VulnerabilityReportCr> vulnerabilityReportCrList =
            await kubernetesClient.CustomObjects
                .ListNamespacedCustomObjectAsync<CustomResourceList<VulnerabilityReportCr>>(
                    myCrd.Group,
                    myCrd.Version,
                    namespaceName,
                    myCrd.PluralName);
        return vulnerabilityReportCrList.Items ?? [];
    }
}
