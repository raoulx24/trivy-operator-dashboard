using TrivyOperator.Dashboard.Domain.Trivy.ClusterVulnerabilityReport;

namespace TrivyOperator.Dashboard.Application.Models;

public class ClusterVulnerabilityReportDto
{
    public Guid Uid { get; init; } = Guid.NewGuid();
    public string ResourceName { get; init; } = string.Empty;
    public string ResourceNamespace { get; init; } = null;
    public string ResourceKind { get; init; } = string.Empty;
    public string ResourceContainerName { get; init; } = string.Empty;
    public string ImageName { get; init; } = string.Empty;
    public string ImageTag { get; init; } = string.Empty;
    public string ImageRepository { get; init; } = string.Empty;
    public string ImageOsFamily { get; init; } = string.Empty;
    public string ImageOsName { get; init; } = string.Empty;
    public bool? ImageEosl { get; init; }
    public long CriticalCount { get; init; } = 0;
    public long HighCount { get; init; } = 0;
    public long MediumCount { get; init; } = 0;
    public long LowCount { get; init; } = 0;
    public long UnknownCount { get; init; } = 0;
    public long NoneCount { get; init; } = 0;
    public ClusterVulnerabilityReportDetailDto[] Details { get; set; } = [];
}

public class ClusterVulnerabilityReportDetailDto
{
    public Guid Id { get; init; } = Guid.NewGuid();
    public string FixedVersion { get; init; } = string.Empty;
    public string InstalledVersion { get; init; } = string.Empty;
    public DateTime? LastModifiedDate { get; init; }
    public Uri? PrimaryLink { get; init; }
    public DateTime? PublishedDate { get; set; }
    public string Resource { get; set; } = string.Empty;
    public float Score { get; set; }
    public int SeverityId { get; set; }
    public string Target { get; set; } = string.Empty;
    public string Title { get; set; } = string.Empty;
    public string VulnerabilityId { get; set; } = string.Empty;
}

public static class ClusterVulnerabilityReportCrExtensions
{
    public static ClusterVulnerabilityReportDto ToClusterVulnerabilityReportDto(this ClusterVulnerabilityReportCr vulnerabilityReportCr)
    {
        List<ClusterVulnerabilityReportDetailDto> clusterVulnerabilityReportDetailDtos = [];
        foreach (Vulnerability vulnerability in vulnerabilityReportCr.Report?.Vulnerabilities ?? [])
        {
            ClusterVulnerabilityReportDetailDto clustervulnerabilityReportDetailDto = new()
            {
                FixedVersion = vulnerability.FixedVersion,
                InstalledVersion = vulnerability.InstalledVersion,
                LastModifiedDate = vulnerability.LastModifiedDate,
                PrimaryLink = vulnerability.PrimaryLink,
                PublishedDate = vulnerability.PublishedDate,
                Resource = vulnerability.Resource,
                Score = vulnerability.Score,
                SeverityId = (int)vulnerability.Severity,
                Target = vulnerability.Target,
                Title = vulnerability.Title,
                VulnerabilityId = vulnerability.VulnerabilityId,
            };
            clusterVulnerabilityReportDetailDtos.Add(clustervulnerabilityReportDetailDto);
        }

        ClusterVulnerabilityReportDto clusterVulnerabilityReportDto = new()
        {
            Uid = new Guid(vulnerabilityReportCr.Metadata.Uid ?? string.Empty),
            ResourceName =
                vulnerabilityReportCr.Metadata.Labels != null &&
                vulnerabilityReportCr.Metadata.Labels.TryGetValue(
                    "trivy-operator.resource.name",
                    out string? resourceName)
                    ? resourceName
                    : string.Empty,
            ResourceNamespace =
                vulnerabilityReportCr.Metadata.Labels != null &&
                vulnerabilityReportCr.Metadata.Labels.TryGetValue(
                    "trivy-operator.resource.namespace",
                    out string? resourceNamespace)
                    ? resourceNamespace
                    : string.Empty,
            ResourceKind =
                vulnerabilityReportCr.Metadata.Labels != null &&
                vulnerabilityReportCr.Metadata.Labels.TryGetValue(
                    "trivy-operator.resource.kind",
                    out string? resourceKind)
                    ? resourceKind
                    : string.Empty,
            ResourceContainerName =
                vulnerabilityReportCr.Metadata.Labels != null &&
                vulnerabilityReportCr.Metadata.Labels.TryGetValue(
                    "trivy-operator.container.name",
                    out string? resourceContainerName)
                    ? resourceContainerName
                    : string.Empty,
            ImageName = vulnerabilityReportCr.Report?.Artifact?.Repository ?? string.Empty,
            ImageTag = vulnerabilityReportCr.Report?.Artifact?.Tag ?? string.Empty,
            ImageRepository = vulnerabilityReportCr.Report?.Registry?.Server ?? string.Empty,
            ImageOsFamily = vulnerabilityReportCr.Report?.Os?.Family ?? string.Empty,
            ImageOsName = vulnerabilityReportCr.Report?.Os?.Name ?? string.Empty,
            ImageEosl = vulnerabilityReportCr.Report?.Os?.Eosl,
            CriticalCount = vulnerabilityReportCr.Report?.Summary?.CriticalCount ?? 0,
            HighCount = vulnerabilityReportCr.Report?.Summary?.HighCount ?? 0,
            MediumCount = vulnerabilityReportCr.Report?.Summary?.MediumCount ?? 0,
            LowCount = vulnerabilityReportCr.Report?.Summary?.LowCount ?? 0,
            UnknownCount = vulnerabilityReportCr.Report?.Summary?.UnknownCount ?? 0,
            Details = [.. clusterVulnerabilityReportDetailDtos],
        };

        return clusterVulnerabilityReportDto;
    }
}