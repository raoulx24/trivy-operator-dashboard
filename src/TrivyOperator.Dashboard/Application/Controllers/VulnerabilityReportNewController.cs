using Microsoft.AspNetCore.Mvc;
using TrivyOperator.Dashboard.Application.Models;
using TrivyOperator.Dashboard.Application.Services.Abstractions;

namespace TrivyOperator.Dashboard.Application.Controllers;

[ApiController]
[Route("api/vulnerability-report-new")]
public class VulnerabilityReportNewController(
    IVulnerabilityReportService vulnerabilityReportService,
    ILogger<VulnerabilityReportsController> logger) : ControllerBase
{
    [HttpGet(Name = "GetVulnerabilityReportDtos")]
    [ProducesResponseType<IEnumerable<VulnerabilityReportDto>>(StatusCodes.Status200OK)]
    [ProducesResponseType<ProblemDetails>(StatusCodes.Status400BadRequest)]
    [ProducesResponseType<ProblemDetails>(StatusCodes.Status500InternalServerError)]
    public async Task<IEnumerable<VulnerabilityReportDto>> Get([FromQuery] string? namespaceName)
    {
        if (namespaceName is null)
        {
            return await vulnerabilityReportService.GetVulnerabilityReportDtos();
        }
        else
        {
            return await vulnerabilityReportService.GetVulnerabilityReportDtos(namespaceName);
        }
    }

    [HttpGet("{uid}", Name = "GetVulnerabilityReportDtoByUid")]
    [ProducesResponseType<IEnumerable<VulnerabilityReportDto>>(StatusCodes.Status200OK)]
    [ProducesResponseType<ProblemDetails>(StatusCodes.Status400BadRequest)]
    [ProducesResponseType<ProblemDetails>(StatusCodes.Status500InternalServerError)]
    public async Task<IActionResult> GetByUid(Guid uid)
    {
        VulnerabilityReportDto? vulnerabilityReportDto = await vulnerabilityReportService.GetVulnerabilityReportDtoByUid(uid);

        if (vulnerabilityReportDto is null)
        {
            return NotFound();
        }
        
        return Ok(vulnerabilityReportDto);
    }
}
