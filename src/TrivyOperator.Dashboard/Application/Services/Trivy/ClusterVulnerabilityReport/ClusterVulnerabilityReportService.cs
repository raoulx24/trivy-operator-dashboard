using TrivyOperator.Dashboard.Application.Models;
using TrivyOperator.Dashboard.Application.Services.Trivy.ClusterVulnerabilityReport.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.ClusterVulnerabilityReport;
using TrivyOperator.Dashboard.Infrastructure.Abstractions;

namespace TrivyOperator.Dashboard.Application.Services.Trivy.ClusterVulnerabilityReport;

public class ClusterVulnerabilityReportService(IConcurrentDictionaryCache<ClusterVulnerabilityReportCr> cache)
    : IClusterVulnerabilityReportService
{
    public Task<IEnumerable<ClusterVulnerabilityReportDto>> GetClusterVulnerabilityReportDtos()
    {
        IEnumerable<ClusterVulnerabilityReportCr> cachedValues = [.. cache.SelectMany(kvp => kvp.Value.Values),];
        IEnumerable<ClusterVulnerabilityReportDto> values = [.. cachedValues
            .Select(cr => cr.ToClusterVulnerabilityReportDto()),];

        return Task.FromResult(values);
    }

    public Task<IEnumerable<ClusterVulnerabilityReportDenormalizedDto>> GetClusterVulnerabilityReportDenormalizedDtos()
    {
        IEnumerable<ClusterVulnerabilityReportCr> cachedValues = [.. cache.SelectMany(kvp => kvp.Value.Values),];
        IEnumerable<ClusterVulnerabilityReportDenormalizedDto> values = [.. cachedValues
            .SelectMany(cr => cr.ToClusterVulnerabilityReportDenormalizedDtos()),];

        return Task.FromResult(values);
    }
}
