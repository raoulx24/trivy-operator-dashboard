using k8s.Models;
using TrivyOperator.Dashboard.Application.Models;
using TrivyOperator.Dashboard.Application.Services.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.VulnerabilityReport;
using TrivyOperator.Dashboard.Infrastructure.Abstractions;

namespace TrivyOperator.Dashboard.Application.Services;

public class VulnerabilityReportService(IConcurrentCache<string, IList<VulnerabilityReportCr>> cache)
    : IVulnerabilityReportService
{
    public Task<List<VulnerabilityDto>> GetTrivyVulnerabilities()
    {
        List<VulnerabilityReportCr> allVulnerabilities = [];
        foreach (string namespaceName in cache.Keys)
        {
            if (cache.TryGetValue(namespaceName, out IList<VulnerabilityReportCr>? vulnerabilities))
            {
                allVulnerabilities.AddRange(vulnerabilities);
            }
        }

        return Task.FromResult(GetDtos(allVulnerabilities));
    }

    public Task<List<VulnerabilityDto>> GetTrivyVulnerabilities(string namespaceName) =>
        cache.TryGetValue(namespaceName, out IList<VulnerabilityReportCr>? vulnerabilities)
            ? Task.FromResult(GetDtos(vulnerabilities))
            : Task.FromResult<List<VulnerabilityDto>>([]);

    private static List<VulnerabilityDto> GetDtos(IList<VulnerabilityReportCr> vulnerabilityReportCrs)
    {
        List<VulnerabilityDto> dtos = [];
        foreach (VulnerabilityReportCr vulnerabilityReportCr in vulnerabilityReportCrs)
        {
            dtos.AddRange(vulnerabilityReportCr.ToVulnerabilityDtos());
        }

        return dtos;
    }

    // TODO - remove the above ones and rename the controller
    // new ones

    public Task<List<VulnerabilityReportDto>> GetVulnerabilityReportDtos()
    {
        List<VulnerabilityReportDto> vulnerabilityReportDtos = [];
        foreach (string namespaceName in cache.Keys)
        {
            if (cache.TryGetValue(namespaceName, out IList<VulnerabilityReportCr>? vulnerabilityReportCrs))
            {
                vulnerabilityReportDtos.AddRange(GetVulnerabilityReportDtos(vulnerabilityReportCrs));
            }
        }

        return Task.FromResult(vulnerabilityReportDtos);
    }

    public Task<List<VulnerabilityReportDto>> GetVulnerabilityReportDtos(string namespaceName)
    {
        return cache.TryGetValue(namespaceName, out IList<VulnerabilityReportCr>? vulnerabilityReportCrs)
            ? Task.FromResult(GetVulnerabilityReportDtos(vulnerabilityReportCrs))
            : Task.FromResult<List<VulnerabilityReportDto>>([]);
    }

    public Task<VulnerabilityReportDto?> GetVulnerabilityReportDtoByUid(Guid uid)
    {
        foreach (string namespaceName in cache.Keys)
        {
            if (cache.TryGetValue(namespaceName, out IList<VulnerabilityReportCr>? vulnerabilityReportCrs))
            {
                VulnerabilityReportCr? vulnerabilityReportCr = vulnerabilityReportCrs.Where(x => x.Metadata.Uid == uid.ToString()).FirstOrDefault();

                if (vulnerabilityReportCr is not null)
                {
                    return Task.FromResult<VulnerabilityReportDto?>(vulnerabilityReportCr.ToVulnerabilityReportDto());
                }
            }
        }

        return Task.FromResult<VulnerabilityReportDto?>(null);
    }

    private static List<VulnerabilityReportDto> GetVulnerabilityReportDtos(IList<VulnerabilityReportCr> vulnerabilityReportCrs)
    {
        List<VulnerabilityReportDto> dtos = [];
        foreach (VulnerabilityReportCr vulnerabilityReportCr in vulnerabilityReportCrs)
        {
            dtos.Add(vulnerabilityReportCr.ToVulnerabilityReportDto());
        }

        return dtos;
    }
}
