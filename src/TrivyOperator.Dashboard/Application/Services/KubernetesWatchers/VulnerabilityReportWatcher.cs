using k8s;
using k8s.Autorest;
using k8s.Models;
using TrivyOperator.Dashboard.Application.Services.BackgroundQueues;
using TrivyOperator.Dashboard.Application.Services.BackgroundQueues.Abstractions;
using TrivyOperator.Dashboard.Application.Services.KubernetesWatchers.Abstractions;
using TrivyOperator.Dashboard.Application.Services.WatcherEvents;
using TrivyOperator.Dashboard.Application.Services.WatcherParams;
using TrivyOperator.Dashboard.Domain.Trivy.CustomResources.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.VulnerabilityReport;
using TrivyOperator.Dashboard.Infrastructure.Abstractions;

namespace TrivyOperator.Dashboard.Application.Services.KubernetesWatchers;

public class VulnerabilityReportWatcher : KubernetesNamespacedWatcher<CustomResourceList<VulnerabilityReportCR>, VulnerabilityReportCR, KubernetesNamespacedWatcherParams, IKubernetesVulnerabilityReportBackgroundQueue, KubernetesVulnerabilityReportWatcherEvent>
{
    public VulnerabilityReportWatcher(IKubernetesClientFactory kubernetesClientFactory,
        IKubernetesVulnerabilityReportBackgroundQueue backgroundQueue,
        ILogger<VulnerabilityReportWatcher> logger) :
        base(kubernetesClientFactory, backgroundQueue, logger)
    {
    }

    protected override async Task<HttpOperationResponse<CustomResourceList<VulnerabilityReportCR>>> GetKubernetesObjectWatchList(KubernetesNamespacedWatcherParams watcherParams, CancellationToken cancellationToken)
    {
        VulnerabilityReportCRD myCrd = new();

        return await kubernetesClient.CustomObjects
                        .ListNamespacedCustomObjectWithHttpMessagesAsync<CustomResourceList<VulnerabilityReportCR>>(
                            myCrd.Group,
                            myCrd.Version,
                            watcherParams.kubernetesNamespace,
                            myCrd.PluralName,
                            watch: true,
                            timeoutSeconds: int.MaxValue,
                            cancellationToken: cancellationToken);
    }

    protected override KubernetesVulnerabilityReportWatcherEvent GetKubernetesWatcherEventWithError(KubernetesNamespacedWatcherParams watcherParams)
    {
        VulnerabilityReportCR vulnerabilityReportCR = new() { Metadata = new() { NamespaceProperty = watcherParams.kubernetesNamespace } };

        return new KubernetesVulnerabilityReportWatcherEvent() { KubernetesObject = vulnerabilityReportCR, WatcherEvent = WatchEventType.Error };
    }
}
