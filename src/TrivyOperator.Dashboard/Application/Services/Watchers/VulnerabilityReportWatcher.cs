using k8s;
using k8s.Autorest;
using k8s.Models;
using TrivyOperator.Dashboard.Application.Services.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.CustomResources.Abstractions;
using TrivyOperator.Dashboard.Domain.Trivy.VulnerabilityReport;

namespace TrivyOperator.Dashboard.Application.Services.Watchers;

public class VulnerabilityReportWatcher : KubernetesWatcher<CustomResourceList<VulnerabilityReportCR>, VulnerabilityReportCR>
{
    public VulnerabilityReportWatcher(ILogger<VulnerabilityReportWatcher> logger)
    {
        this.logger = logger;
    }

    protected override async Task<HttpOperationResponse<CustomResourceList<VulnerabilityReportCR>>> GetKubernetesObjectWatchList(Kubernetes k8sClient, string? k8sNamespace, CancellationToken cancellationToken)
    {
        VulnerabilityReportCRD myCrd = new();

        return await k8sClient.CustomObjects
                        .ListNamespacedCustomObjectWithHttpMessagesAsync<CustomResourceList<VulnerabilityReportCR>>(
                            myCrd.Group,
                            myCrd.Version,
                            k8sNamespace,
                            myCrd.PluralName,
                            watch: true,
                            timeoutSeconds: int.MaxValue,
                            cancellationToken: cancellationToken);
    }
    protected override Task ProcessWatchEvent(WatchEventType type, VulnerabilityReportCR item, string? k8sNamespace, CancellationToken cancellationToken)
    {
        return Task.CompletedTask;
    }
}
